---
title: "Sarcoidosis Validation IL-33 - Oncostatin-M axis accross all cell clusters"
author: "Emily Payne"
date: "2025-06-05"
output: html_document
---

```{r setup, include = FALSE, warning = FALSE, message = FALSE}

options (width = 100)
knitr::opts_chunk$set(warning = FALSE, echo = TRUE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234

```


```{r load libraries}

suppressPackageStartupMessages({
  library(Seurat)
  library(ggpubr)
  library(pheatmap)
  library(SingleCellExperiment)
  library(dplyr)
  library(tidyverse)
  library(viridis)
  library(muscat)
  library(circlize)
  library(destiny)
  library(scater)
  library(metap)
  library(multtest)
  library(clusterProfiler)
  library(org.Hs.eg.db)
  library(msigdbr)
  library(enrichplot)
  library(DOSE)
  library(grid)
  library(gridExtra)
  library(ggupset)
  library(VennDiagram)
  library(NCmisc)
  library(RColorBrewer)
  library(EnhancedVolcano)
  library(textshaping)
  library(wordcloud)
  library(pathview)
  library(workflowr)
  library(future)
  library(tibble)
  library(tidyr)
library(circlize)
library(magrittr)
})

```




```{r}
seuratM <- readRDS("~/Documents/Github/Cardiac Sarcoidosis/data/Merged/Sarcoidosis_vs_DonorHeart_v2.rds")
"data/Merged/Sarcoidosis_vs_DonorHeart_v2.rds"
```


```{r, echo = FALSE, warning = FALSE}

seuratM <- subset (seuratM, clusterName %in% c("CM", "Fb1","PeriFb", "VSMC", "BEC1","BEC2", "NC1", "TRM", "inflMph","Lymphocytes"))

table(seuratM$orig.ident)
```



## UMAP
```{r, echo = F}

colclusterName <- c("#f4a582", "#FEE08B", "#3288BD", "#253494",  "#01665e", "#66C2A5", "#355C7D", "#a6bddb", "#fde0dd", "#dd1c77")

names(colclusterName) <- c("CM", "Fb1","PeriFb", "VSMC", "BEC1","BEC2", "NC1", "TRM", "inflMph","Lymphocytes")

seuratM$clusterName <- factor(seuratM$clusterName, levels=c("CM", "Fb1", "PeriFb", "VSMC", "BEC1","BEC2", "NC1", "TRM", "inflMph","Lymphocytes"))

Idents(seuratM) <- seuratM$clusterName
DimPlot(seuratM, reduction = "umap",label = TRUE, cols = colclusterName, repel = TRUE, pt.size = 0.01)


```


# Heatmap with Marker Genes
```{r, fig.height = 8, echo = F}


Idents(seuratM) <- seuratM$clusterName


genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("TTN", "MYBPC3", "RYR2", "TNNT2", "COL6A3", "DCN",  "FBN1", "C7", "PDGFRA", "PDGFRB", "RGS5", "NOTCH3", "MYH11", "ACTA2","PECAM1", "VWF", "EGFL7", "POSTN", "ITGA10", "NRXN1", "ANK3", "PTPRZ1", "CNTN2", "SNAP25", "ICAM1", "CD163", "LYVE1", "MRC1", "SIGLEC1", "STAB1", "CSF1R","MERTK", "SEMA4A", "HLA-DQB1", "CCR2", "IGHM", "GZMB", "IFNG", "IL7R","CD3E", "PTPRC", "CD2", "CD3E"))) %>% left_join(., genes, by="geneID") %>% filter(gene != "ENSG00000232995.RGS5") 


avgHeatmap <- function(seuratM, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  selGenes <- selGenes$gene
  
  clusterAssigned <- as.data.frame(Idents(seuratM)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seuratM)
  

  genes <- data.frame(gene=rownames(seuratM)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]


  annotation_col <- as.data.frame(gsub("(^.*?_)","",
                                       colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=gsub("(_.*$)","",colnames(logNormExpresMa)))
  colnames(annotation_col)[1] <- "col1"
  annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
    dplyr::select(cond, celltype)
  rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      celltype=colVec)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
  ordVec <- levels(seuratM)
  ordVec <- c("CM", "Fb1", "PeriFb", "VSMC", "BEC1","BEC2", "NC1", "TRM", "inflMph","Lymphocytes")
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0,cluster_rows = cr, 
         cluster_cols = cc, color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

genesPlot <- data.frame(gene=c("TTN", "MYBPC3", "RYR2", "TNNT2", "COL6A3", "DCN",  "FBN1", "C7", "PDGFRA", "PDGFRB", "RGS5", "NOTCH3", "MYH11", "ACTA2","PECAM1", "VWF", "EGFL7", "POSTN", "ITGA10", "NRXN1", "ANK3", "PTPRZ1", "CNTN2", "ICAM1", "CD163", "LYVE1", "MRC1", "SIGLEC1", "STAB1", "CSF1R","MERTK", "SEMA4A", "HLA-DQB1", "CCR2", "IGHM", "GZMB", "IFNG", "IL7R","CD3E", "PTPRC", "CD2"))


levels(seuratM)


colVec <- colclusterName

# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")

avgHeatmap(seuratM, selGenes = genesPlot, colVecIdent = colVec)




```



```{r, echo = FALSE}
Idents(seuratM) <- seuratM$clusterName

markers <- FindAllMarkers(seuratM, only.pos = T) %>%
                            dplyr::filter(p_val_adj < 0.01)


markers <- markers %>% 
  mutate(Gene=gene) %>%
  mutate(gene=gsub("^.*\\.", "", Gene))  %>%
  mutate(EnsID=gsub("\\..*","", Gene))

#View(markers)

```


## Heatmap with IL33-OSM axis
```{r, echo = F}

Idents(seuratM) <- seuratM$clusterName


genes <- data.frame(gene=rownames(seuratM)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("IL1B", "OSM", "IL1RL1", "IL33", "OSMR", "LIFR",  "IL6ST", "IL1R1", "IL1RAP", "CCL11"))) %>% left_join(., genes, by="geneID") %>% filter(gene != "ENSG00000232995.RGS5") 


avgHeatmap <- function(seuratM, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  selGenes <- selGenes$gene
  
  clusterAssigned <- as.data.frame(Idents(seuratM)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seuratM)
  

  genes <- data.frame(gene=rownames(seuratM)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]


  annotation_col <- as.data.frame(gsub("(^.*?_)","",
                                       colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=gsub("(_.*$)","",colnames(logNormExpresMa)))
  colnames(annotation_col)[1] <- "col1"
  annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
    dplyr::select(cond, celltype)
  rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      celltype=colVec)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
  ordVec <- levels(seuratM)
  ordVec <- c("CM", "Fb1", "PeriFb", "VSMC", "BEC1","BEC2", "NC1", "TRM", "inflMph","Lymphocytes")
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0,cluster_rows = cr, 
         cluster_cols = cc, color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

genesPlot <- data.frame(gene=c("IL1B", "OSM", "IL1RL1", "IL33", "OSMR", "LIFR",  "IL6ST", "IL1R1", "IL1RAP", "CCL11"))


levels(seuratM)


colVec <- colclusterName

# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")

#pdf("heatmap marker genes _v2.pdf", width = 8, height = 6)  
avgHeatmap(seuratM, selGenes = genesPlot, colVecIdent = colVec)
#dev.off()

#genesPlot <- data.frame(gene=c("BMP4", "GREM1", "GREM2"))



```


```{r, echo = F}
library(tibble)
library(tidyr)
library(circlize)
library(magrittr)

Remove_ensebl_id <- function(data_conv){
  data_conv <- as.SingleCellExperiment(data_conv, assay = "RNA")
  
  gene_name_fixdf <- data.frame(Gene_Name = rownames(data_conv))
  gene_name_fixdf$Symbol <- gsub("^[^.]*.","", gene_name_fixdf$Gene_Name)
  
  
  duplidx <- rownames((gene_name_fixdf[duplicated(gene_name_fixdf$Symbol), ]))
  
  while (length(duplidx)>0){
    Fixed_dupl <- gene_name_fixdf %>% 
      filter(row_number() %in% duplidx)  %>% 
      mutate(Symbol = paste0(Symbol, ".4"))
    gene_name_fixdf[duplidx,"Symbol"] <- Fixed_dupl$Symbol
    rownames(data_conv) <- gene_name_fixdf$Symbol
    duplidx <- rownames((gene_name_fixdf[duplicated(gene_name_fixdf$Symbol), ]))
  }
  
  # Convert SingleCellexperiment object back to seurat object by retaining the reductions, normalization, etc
  data_conv <- as.Seurat(data_conv, assay = NULL)
  return(data_conv)
}
```

## Dotplot with genes: IL33-OSM axis
```{r, echo = F}
seuratM_conv <- seuratM
data_conv <-Remove_ensebl_id(seuratM_conv)

Idents(data_conv) <- data_conv$clusterName

levels(data_conv)<-levels(data_conv)[order(match(levels(data_conv),c("CM", "Fb1", "PeriFb", "VSMC", "BEC1","BEC2", "NC1", "TRM", "inflMph","Lymphocytes")))]

order_clusters <- c("CM", "Fb1", "PeriFb", "VSMC", "BEC1","BEC2", "NC1", "TRM", "inflMph","Lymphocytes")

data_conv$clusterName <- factor(data_conv$clusterName, levels = order_clusters)


gene_list <- rev(c("IL1B", "OSM", "IL1RL1", "IL33", "OSMR", "LIFR",  "IL6ST", "IL1R1", "IL1RAP", "CCL11"))


seuratM$clusterName <- factor(seuratM$clusterName, levels = c("CM", "Fb1", "PeriFb", "VSMC", "BEC1","BEC2", "NC1", "TRM", "inflMph","Lymphocytes"))


DotPlot(data_conv, features = gene_list, group.by= "clusterName") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip() + ggtitle("Celltype assignment" + theme(axis.text.y = element_text(size = 10)))


```
## Feature Plots with genes: IL33-OSM axis
```{r, echo = F}

get_full_gene_name <- function(gene, obj){
  return(grep(gene,rownames(obj), value =TRUE))
}
get_full_gene_name("OSM",seuratM) 


Idents(seuratM) <- seuratM$clusterName
DimPlot(seuratM, reduction = "umap",label = TRUE, cols = colclusterName, repel = TRUE, pt.size = 0.01)

FeaturePlot(seuratM, features = get_full_gene_name("IL1B",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000099985.OSM", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000115602.IL1RL1", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000137033.IL33", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000145623.OSMR", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000113594.LIFR", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000134352.IL6ST", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000115594.IL1R1", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = "ENSG00000196083.IL1RAP", pt.size = 1, cols = c("lightgrey", "#BE3144"))
FeaturePlot(seuratM, features = get_full_gene_name("CCL11",seuratM) , pt.size = 1, cols = c("lightgrey", "#BE3144"))

```


## Vln Plots genes involved in IL33-OSM axis per cluster accross all conditions

```{r, echo = F}
VlnPlot(seuratM, features = "ENSG00000125538.IL1B", pt.size = 0.01, group.by ="clusterName") +
  scale_fill_manual(values = colclusterName) + ggtitle ("IL1B")

VlnPlot(seuratM, features = "ENSG00000099985.OSM", pt.size = 0.01, group.by ="clusterName") +
  scale_fill_manual(values = colclusterName) + ggtitle ("OSM")

VlnPlot(seuratM, features = "ENSG00000115602.IL1RL1", pt.size = 0.01, group.by ="clusterName") +
  scale_fill_manual(values = colclusterName) + ggtitle ("IL1RL1")

VlnPlot(seuratM, features = "ENSG00000137033.IL33", pt.size = 0.01, group.by ="clusterName") +
  scale_fill_manual(values = colclusterName) + ggtitle ("IL33")

VlnPlot(seuratM, features = "ENSG00000113594.LIFR", pt.size = 0.01, group.by ="clusterName") +
  scale_fill_manual(values = colclusterName) + ggtitle ("LIFR")

VlnPlot(seuratM, features = "ENSG00000134352.IL6ST", pt.size = 0.01, group.by ="clusterName") +
  scale_fill_manual(values = colclusterName) + ggtitle ("IL6ST")

VlnPlot(seuratM, features = "ENSG00000115594.IL1R1", pt.size = 0.01, group.by ="clusterName") +
  scale_fill_manual(values = colclusterName) + ggtitle ("IL1R1")

VlnPlot(seuratM, features = "ENSG00000196083.IL1RAP", pt.size = 0.01, group.by ="clusterName") +
  scale_fill_manual(values = colclusterName) + ggtitle ("IL1RAP")

VlnPlot(seuratM, features = "ENSG00000172156.CCL11", pt.size = 0.01, group.by ="clusterName") +
  scale_fill_manual(values = colclusterName) + ggtitle ("CCL11")

```



## Violin Plots with genes involved in the IL133-OSM axis by condition
```{r}
 #c("ENSG00000125538.IL1B", "ENSG00000099985.OSM", "ENSG00000115602.IL1RL1", "ENSG00000137033.IL33", #"ENSG00000113594.LIFR", "ENSG00000134352.IL6ST", "ENSG00000115594.IL1R1", "ENSG00000196083.IL1RAP")

VlnPlot(seuratM, features = "ENSG00000125538.IL1B", pt.size = 0.01, group.by ="pat_sub") +
  scale_fill_manual(values = c("#355C7D", "#dfc27d")) + ggtitle ("IL1B")

VlnPlot(seuratM, features = "ENSG00000099985.OSM", pt.size = 0.01, group.by ="pat_sub") +
  scale_fill_manual(values = c("#355C7D", "#dfc27d")) + ggtitle ("OSM")

VlnPlot(seuratM, features = "ENSG00000115602.IL1RL1", pt.size = 0.01, group.by ="pat_sub") +
  scale_fill_manual(values = c("#355C7D", "#dfc27d")) + ggtitle ("IL1RL1")

VlnPlot(seuratM, features = "ENSG00000137033.IL33", pt.size = 0.01, group.by ="pat_sub") +
  scale_fill_manual(values = c("#355C7D", "#dfc27d")) + ggtitle ("IL33")

VlnPlot(seuratM, features = "ENSG00000113594.LIFR", pt.size = 0.01, group.by ="pat_sub") +
  scale_fill_manual(values = c("#355C7D", "#dfc27d")) + ggtitle ("LIFR")

VlnPlot(seuratM, features = "ENSG00000134352.IL6ST", pt.size = 0.01, group.by ="pat_sub") +
  scale_fill_manual(values = c("#355C7D", "#dfc27d")) + ggtitle ("IL6ST")

VlnPlot(seuratM, features = "ENSG00000115594.IL1R1", pt.size = 0.01, group.by ="pat_sub") +
  scale_fill_manual(values = c("#355C7D", "#dfc27d")) + ggtitle ("IL1R1")

VlnPlot(seuratM, features = "ENSG00000196083.IL1RAP", pt.size = 0.01, group.by ="pat_sub") +
  scale_fill_manual(values = c("#355C7D", "#dfc27d")) + ggtitle ("IL1RAP")

VlnPlot(seuratM, features = "ENSG00000172156.CCL11", pt.size = 0.01, group.by ="pat_sub") +
  scale_fill_manual(values = c("#355C7D", "#dfc27d")) + ggtitle ("CCL11")


```





## Comparison of genes clusterwise per condition

```{r}

colpat_sub <- c("DonorHeart" = "#355C7D", "Sarcoidosis" = "#dfc27d")
#colclusterName <- c("Macrophages" = "#1f77b4", "T cells" = "#ff7f0e", "NK cells" = "#2ca02c")  # Adjust as needed


genes <- c("ENSG00000125538.IL1B", "ENSG00000099985.OSM", "ENSG00000115602.IL1RL1", "ENSG00000137033.IL33", "ENSG00000113594.LIFR", "ENSG00000134352.IL6ST", "ENSG00000115594.IL1R1", "ENSG00000196083.IL1RAP" )


for (gene_name in genes) {
  
  
  expr <- GetAssayData(seuratM, slot = "data")[gene_name, ]
  
 
  df <- data.frame(expression = as.numeric(expr), clusterName = seuratM$clusterName, pat_sub = seuratM$pat_sub)
  
  df$clusterName <- factor(df$clusterName, levels = names(colclusterName))
  df$pat_sub <- factor(df$pat_sub, levels = names(colpat_sub))
  

  pvals <- df %>%
    group_by(clusterName) %>%
    summarise(
      p_val = wilcox.test(expression ~ pat_sub, exact = FALSE)$p.value,
      .groups = "drop") %>%
    mutate(p_label = sprintf("p = %.3f", p_val))
  
  y_pos <- df %>%
    group_by(clusterName) %>%
    summarise(y = max(expression, na.rm = TRUE) * 1.05, .groups = "drop")
  
  pvals <- left_join(pvals, y_pos, by = "clusterName")
  

 graph <- ggplot(df, aes(x = clusterName, y = expression, fill = pat_sub)) +
  geom_violin(position = position_dodge(width = 0.9), trim = TRUE, alpha = 0.7) +
  geom_jitter(
    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9),
    size = 0.5,
    alpha = 0.6,
    color = "black") +
  scale_fill_manual(values = colpat_sub) +
  theme_classic() +
  labs(title = paste("Expression of", gene_name, "by Cluster and Condition"),
       x = "Cell Type (Cluster)",
       y = "Normalized Expression") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, color = colclusterName[levels(df$clusterName)]),
    plot.title = element_text(hjust = 0.5)) + geom_text(data = pvals, aes(x = clusterName, y = y, label = p_label),
            inherit.aes = FALSE, vjust = 0, size = 3)

  
  print(graph)
}


```


```{r, echo = F}
Idents(seuratM) <- seuratM$clusterName

DEGenesClusters <- FindAllMarkers(seuratM, only.pos = F) %>%
                            dplyr::filter(p_val_adj < 0.01)


DEGenesClusters <- DEGenesClusters %>% 
  mutate(Gene=gene) %>%
  mutate(gene=gsub("^.*\\.", "", Gene))  %>%
  mutate(EnsID=gsub("\\..*","", Gene))

```


## Gene ontology for fibroblasts and macrophages
```{r}
## DE Genes Fibroblasts
DEGenesFb <- DEGenesClusters %>% filter(cluster == "Fb1")

egoFb <- enrichGO(gene = unique(DEGenesFb$EnsID),
                          OrgDb = org.Hs.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)

egoFb <- setReadable(egoFb, OrgDb = org.Hs.eg.db)


#dotplot(egoFb, showCategory=20, title = "Fibroblast G0 terms", font.size = 10)

#View(egoFb@result)

barplot(egoFb, 
        drop = TRUE, 
        showCategory = 5, 
        title = "Fibroblast G0 terms",
        font.size = 10)
```



```{r}

## DE Genes Tissue resident macrophages
DEGenesTRM <- DEGenesClusters %>% filter(cluster == "TRM")

egoTRM <- enrichGO(gene = unique(DEGenesTRM$EnsID),
                          OrgDb = org.Hs.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)

egoTRM <- setReadable(egoTRM, OrgDb = org.Hs.eg.db)


#dotplot(egoTRM, showCategory=20, title = "Tissue resident macrophages GO terms", font.size = 10)

#View(egoTRM@result)

barplot(egoTRM, 
        drop = TRUE, 
        showCategory = 5, 
        title = "Tissue resident macrophages GO terms",
        font.size = 10)


```


```{r}
## DE Genes inflammatory macrophages
DEGenesinflMph <- DEGenesClusters %>% filter(cluster == "inflMph")

egoMph <- enrichGO(gene = unique(DEGenesinflMph$EnsID),
                          OrgDb = org.Hs.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)

egoMph <- setReadable(egoMph, OrgDb = org.Hs.eg.db)


#dotplot(egoMph, showCategory=20, title = "Inflammatory macrophages", font.size = 10)

#View(egoMph@result)

barplot(egoMph, 
        drop = TRUE, 
        showCategory = 5, 
        title = "Inflammatory Macrophages GO terms",
        font.size = 10)
```

### Single cell Experiment with Pathway Analysis projected on UMAP
```{r}

sce <- as.SingleCellExperiment(seuratM)
genes <- data.frame(geneID=rownames(sce)) %>% mutate(gene=gsub(".*\\.", "", geneID))
pal = colorRampPalette(c("#053061", "#2166ac", "#f7f7f7", "#f4a582","orange", "#d95f0e","#b2183c"))
scale_fill_gradientn(colors = pal(101), na.value = "grey90")

```

```{r}

seuratDH <- subset(seuratM, pat_sub == "DonorHeart")
table(seuratDH$pat_sub)

sceDH <- as.SingleCellExperiment(seuratDH)
```

```{r}

seuratSarco <- subset(seuratM, pat_sub == "Sarcoidosis")
table(seuratSarco$pat_sub)
sceSarco <- as.SingleCellExperiment(seuratSarco)

```



## Leukocyte migration pathway projected on UMAP
```{r, echo = F}
#class(egoFb)

#colnames(egoFb)

#egoFb <- dplyr::filter(egoFb@result, egoFb@result$Description %in% c("leukocyte migration", "regulation of leukocyte migration", "regulation of leukocyte differentiation" ))

## egoFb1 <- dplyr::filter(egoFb, Description

egoFb1 <- dplyr::filter(egoFb@result, egoFb@result$Description %in% c("leukocyte migration", "regulation of leukocyte migration", "regulation of leukocyte differentiation", "myeloid leukocyte differentiation", "positive regulation of leukocyte differentiation", "regulation of leukocyte chemotaxis", "positive regulation of leukocyte chemotaxis", "	
leukocyte chemotaxis", "leukocyte activation involved in immune response", "regulation of leukocyte degranulation", "regulation of myeloid leukocyte mediated immunity", "myeloid leukocyte cytokine production", "positive regulation of leukocyte cell-cell adhesion", "positive regulation of leukocyte tethering or rolling", "	
positive regulation of myeloid leukocyte differentiation", "positive regulation of myeloid leukocyte cytokine production involved in immune response", "regulation of leukocyte proliferation", "myeloid leukocyte mediated immunity", "eukocyte tethering or rolling", "positive regulation of leukocyte adhesion to vascular endothelial cell", "leukocyte migration involved in inflammatory response", "positive regulation of leukocyte degranulation", "positive regulation of myeloid leukocyte mediated immunity", "positive regulation of leukocyte apoptotic process", "egulation of leukocyte adhesion to vascular endothelial cell", "leukocyte activation involved in inflammatory response", "leukocyte activation involved in inflammatory response", "regulation of leukocyte adhesion to arterial endothelial cell", "leukocyte adhesion to arterial endothelial cell","positive regulation of leukocyte mediated immunity", "positive regulation of leukocyte mediated cytotoxicity", "leukocyte mediated cytotoxicity" ))


## geneID extraction
g0 <- egoFb1$geneID
Str <- unlist(strsplit(g0, "/"))
df <- as.data.frame(Str)
colnames(df) <- c("gene")

## signature Genes in count matrix
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)
if (nrow(signGenes) == 0) stop("No signature genes found.")

## sce object for signature genes
sceSub <- sce[rownames(sce) %in% unique(signGenes$geneID), ]
if (nrow(sceSub) == 0) stop("No matching genes found in sce.")

## gene signature matrix
cntMat <- rowSums(t(as.matrix(sceSub@assays@data$logcounts))) / nrow(signGenes)
if (length(cntMat) != ncol(sceSub)) stop("Mismatch between cntMat and sceSub dimensions.")

sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign

sceSub$sign2[which(sceSub$sign > 2)] <- 2


sc <- scale_colour_gradientn(colours = pal(100), limits = c(0, 2))

## UMAP all conditions
plotUMAP(sceSub, colour_by = "sign2", point_size = 0.5) + sc

```


```{r}
## Sarcoidosis 
sceSarcoSub <- sceSarco[which(rownames(sceSarco) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSarcoSub@assays@data$logcounts)))/nrow(signGenes)
sceSarcoSub$sign <- cntMat
sceSarcoSub$sign2 <- sceSarcoSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceSarcoSub$sign2[which(sceSarcoSub$sign > 1)] <- 1
#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceSarcoSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()

```



```{r}
## Donor Heart
sceDHSub <- sceDH[which(rownames(sceDH) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceDHSub@assays@data$logcounts)))/nrow(signGenes)
sceDHSub$sign <- cntMat
sceDHSub$sign2 <- sceDHSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceDHSub$sign2[which(sceDHSub$sign > 1)] <- 1

#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceDHSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()

```





## Extracellular matrix organisation
```{r, echo = F}
## ECM organisation all conditions

egoFb2 <- dplyr::filter(egoFb@result, egoFb@result$Description %in% c(	"extracellular structure organization", "extracellular matrix organization", "regulation of extracellular matrix organization", "extracellular matrix assembly", "extracellular matrix constituent secretion", "positive regulation of extracellular matrix organization", "positive regulation of extracellular matrix assembly", "regulation of extracellular matrix assembly"))


## geneID extraction
g1 <- egoFb2$geneID
Str <- unlist(strsplit(g1, "/"))
df <- as.data.frame(Str)
colnames(df) <- c("gene")

## signature Genes in count matrix
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)
if (nrow(signGenes) == 0) stop("No signature genes found.")

## sce object for signature genes
sceSub <- sce[rownames(sce) %in% unique(signGenes$geneID), ]
if (nrow(sceSub) == 0) stop("No matching genes found in sce.")

## gene signature matrix
cntMat <- rowSums(t(as.matrix(sceSub@assays@data$logcounts))) / nrow(signGenes)
if (length(cntMat) != ncol(sceSub)) stop("Mismatch between cntMat and sceSub dimensions.")

sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign

sceSub$sign2[which(sceSub$sign > 2)] <- 2


sc <- scale_colour_gradientn(colours = pal(100), limits = c(0, 2))

## UMAP all conditions
plotUMAP(sceSub, colour_by = "sign2", point_size = 0.5) + sc


```



```{r}
## Sarcoidosis: ECM organisation
sceSarcoSub <- sceSarco[which(rownames(sceSarco) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSarcoSub@assays@data$logcounts)))/nrow(signGenes)
sceSarcoSub$sign <- cntMat
sceSarcoSub$sign2 <- sceSarcoSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceSarcoSub$sign2[which(sceSarcoSub$sign > 1)] <- 1
#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceSarcoSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()

```




```{r}

## Donor Heart: ECM organisation
sceDHSub <- sceDH[which(rownames(sceDH) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceDHSub@assays@data$logcounts)))/nrow(signGenes)
sceDHSub$sign <- cntMat
sceDHSub$sign2 <- sceDHSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceDHSub$sign2[which(sceDHSub$sign > 1)] <- 1

#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceDHSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()

```


## Response to Interferon beta

```{r}

egoFb3 <- dplyr::filter(egoFb@result, egoFb@result$Description %in% c("response to interferon-beta", "cellular response to interferon-beta", "positive regulation of interferon-beta production", "interferon-beta production", "	
positive regulation of type I interferon production", "regulation of type I interferon production", "type I interferon production", "cellular response to type I interferon", "response to type I interferon", "regulation of type I interferon-mediated signaling pathway", "interferon-mediated signaling pathway", "positive regulation of interferon-alpha production", "nterferon-alpha production", "regulation of interferon-alpha production", "positive regulation of type I interferon-mediated signaling pathway", "response to interferon-alpha", "cellular response to interferon-alpha"))



## geneID extraction
g2 <- egoFb3$geneID
Str <- unlist(strsplit(g2, "/"))
df <- as.data.frame(Str)
colnames(df) <- c("gene")

## signature Genes in count matrix
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)
if (nrow(signGenes) == 0) stop("No signature genes found.")

## sce object for signature genes
sceSub <- sce[rownames(sce) %in% unique(signGenes$geneID), ]
if (nrow(sceSub) == 0) stop("No matching genes found in sce.")

## gene signature matrix
cntMat <- rowSums(t(as.matrix(sceSub@assays@data$logcounts))) / nrow(signGenes)
if (length(cntMat) != ncol(sceSub)) stop("Mismatch between cntMat and sceSub dimensions.")

sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign

sceSub$sign2[which(sceSub$sign > 2)] <- 2


sc <- scale_colour_gradientn(colours = pal(100), limits = c(0, 2))

## UMAP all conditions for Interferon alpha pathway
plotUMAP(sceSub, colour_by = "sign2", point_size = 0.5) + sc

## Sarcoidosis: ECM organisation
sceSarcoSub <- sceSarco[which(rownames(sceSarco) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSarcoSub@assays@data$logcounts)))/nrow(signGenes)
sceSarcoSub$sign <- cntMat
sceSarcoSub$sign2 <- sceSarcoSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceSarcoSub$sign2[which(sceSarcoSub$sign > 1)] <- 1
#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceSarcoSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()


## Donor Heart: ECM organisation
sceDHSub <- sceDH[which(rownames(sceDH) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceDHSub@assays@data$logcounts)))/nrow(signGenes)
sceDHSub$sign <- cntMat
sceDHSub$sign2 <- sceDHSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceDHSub$sign2[which(sceDHSub$sign > 1)] <- 1

#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceDHSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()

```
## IL-33 pathway
```{r}

egoFb4 <- dplyr::filter(egoFb@result, egoFb@result$Description %in% c("regulation of interleukin-33 production", "	
interleukin-33 production"))


## geneID extraction
g3 <- egoFb4$geneID
Str <- unlist(strsplit(g3, "/"))
df <- as.data.frame(Str)
colnames(df) <- c("gene")

## signature Genes in count matrix
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)
if (nrow(signGenes) == 0) stop("No signature genes found.")

## sce object for signature genes
sceSub <- sce[rownames(sce) %in% unique(signGenes$geneID), ]
if (nrow(sceSub) == 0) stop("No matching genes found in sce.")

## gene signature matrix
cntMat <- rowSums(t(as.matrix(sceSub@assays@data$logcounts))) / nrow(signGenes)
if (length(cntMat) != ncol(sceSub)) stop("Mismatch between cntMat and sceSub dimensions.")

sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign

sceSub$sign2[which(sceSub$sign > 2)] <- 2


sc <- scale_colour_gradientn(colours = pal(100), limits = c(0, 2))

## UMAP all conditions IL33
plotUMAP(sceSub, colour_by = "sign2", point_size = 0.5) + sc

## Sarcoidosis: IL33
sceSarcoSub <- sceSarco[which(rownames(sceSarco) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSarcoSub@assays@data$logcounts)))/nrow(signGenes)
sceSarcoSub$sign <- cntMat
sceSarcoSub$sign2 <- sceSarcoSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceSarcoSub$sign2[which(sceSarcoSub$sign > 1)] <- 1
#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceSarcoSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()


## Donor Heart: IL33
sceDHSub <- sceDH[which(rownames(sceDH) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceDHSub@assays@data$logcounts)))/nrow(signGenes)
sceDHSub$sign <- cntMat
sceDHSub$sign2 <- sceDHSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceDHSub$sign2[which(sceDHSub$sign > 1)] <- 1

#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceDHSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()



```


## Interleukin 1 pathway
```{r}

egoFb5 <- dplyr::filter(egoFb@result, egoFb@result$Description %in% c("response to interleukin-1", "cellular response to interleukin-1", "positive regulation of interleukin-1 alpha production", "interleukin-1-mediated signaling pathway", "interleukin-1 alpha production", "regulation of interleukin-1 alpha production", "positive regulation of interleukin-1 beta production", "positive regulation of interleukin-1 production", "	
interleukin-1 beta production", "regulation of interleukin-1 beta production", "negative regulation of interleukin-1 production", "interleukin-1 production", "regulation of interleukin-1 production", "regulation of interleukin-1-mediated signaling pathway"))


## geneID extraction
g4 <- egoFb5$geneID
Str <- unlist(strsplit(g4, "/"))
df <- as.data.frame(Str)
colnames(df) <- c("gene")

## signature Genes in count matrix
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)
if (nrow(signGenes) == 0) stop("No signature genes found.")

## sce object for signature genes
sceSub <- sce[rownames(sce) %in% unique(signGenes$geneID), ]
if (nrow(sceSub) == 0) stop("No matching genes found in sce.")

## gene signature matrix
cntMat <- rowSums(t(as.matrix(sceSub@assays@data$logcounts))) / nrow(signGenes)
if (length(cntMat) != ncol(sceSub)) stop("Mismatch between cntMat and sceSub dimensions.")

sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign

sceSub$sign2[which(sceSub$sign > 2)] <- 2


sc <- scale_colour_gradientn(colours = pal(100), limits = c(0, 2))

## UMAP all conditions Interleukin-1
plotUMAP(sceSub, colour_by = "sign2", point_size = 0.5) + sc

## Sarcoidosis: Interleukin-1
sceSarcoSub <- sceSarco[which(rownames(sceSarco) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSarcoSub@assays@data$logcounts)))/nrow(signGenes)
sceSarcoSub$sign <- cntMat
sceSarcoSub$sign2 <- sceSarcoSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceSarcoSub$sign2[which(sceSarcoSub$sign > 1)] <- 1
#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceSarcoSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()


## Donor Heart: Interleukin-1
sceDHSub <- sceDH[which(rownames(sceDH) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceDHSub@assays@data$logcounts)))/nrow(signGenes)
sceDHSub$sign <- cntMat
sceDHSub$sign2 <- sceDHSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceDHSub$sign2[which(sceDHSub$sign > 1)] <- 1

#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceDHSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()



```

## Lymphocyte differentiation

```{r}

egoFb6 <- dplyr::filter(egoFb@result, egoFb@result$Description %in% c("lymphocyte differentiation", "positive regulation of lymphocyte differentiation", "regulation of lymphocyte differentiation", "lymphocyte costimulation", "lymphocyte migration", "positive regulation of lymphocyte activation", "lymphocyte activation involved in immune response", "regulation of lymphocyte migration", "lymphocyte chemotaxis", "positive regulation of lymphocyte proliferation", "regulation of lymphocyte proliferation", "establishment of lymphocyte polarity", "	
positive regulation of lymphocyte migration", "positive regulation of lymphocyte chemotaxis", "regulation of lymphocyte chemotaxis", "regulation of lymphocyte mediated immunity"))
                                                                    

## geneID extraction
g5 <- egoFb6$geneID
Str <- unlist(strsplit(g5, "/"))
df <- as.data.frame(Str)
colnames(df) <- c("gene")

## signature Genes in count matrix
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)
if (nrow(signGenes) == 0) stop("No signature genes found.")

## sce object for signature genes
sceSub <- sce[rownames(sce) %in% unique(signGenes$geneID), ]
if (nrow(sceSub) == 0) stop("No matching genes found in sce.")

## gene signature matrix
cntMat <- rowSums(t(as.matrix(sceSub@assays@data$logcounts))) / nrow(signGenes)
if (length(cntMat) != ncol(sceSub)) stop("Mismatch between cntMat and sceSub dimensions.")

sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign

sceSub$sign2[which(sceSub$sign > 2)] <- 2


sc <- scale_colour_gradientn(colours = pal(100), limits = c(0, 2))

## UMAP all conditions 
plotUMAP(sceSub, colour_by = "sign2", point_size = 0.5) + sc

## Sarcoidosis: 
sceSarcoSub <- sceSarco[which(rownames(sceSarco) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSarcoSub@assays@data$logcounts)))/nrow(signGenes)
sceSarcoSub$sign <- cntMat
sceSarcoSub$sign2 <- sceSarcoSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceSarcoSub$sign2[which(sceSarcoSub$sign > 1)] <- 1
#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceSarcoSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()


## Donor Heart: 
sceDHSub <- sceDH[which(rownames(sceDH) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceDHSub@assays@data$logcounts)))/nrow(signGenes)
sceDHSub$sign <- cntMat
sceDHSub$sign2 <- sceDHSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceDHSub$sign2[which(sceDHSub$sign > 1)] <- 1

#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceDHSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()


```
## BMP signaling pathway
```{r}


egoFb7 <- dplyr::filter(egoFb@result, egoFb@result$Description %in% c("response to BMP", "cellular response to BMP stimulus", "regulation of BMP signaling pathway",	 "BMP signaling pathway", "positive regulation of BMP signaling pathway"))
                                                                    

## geneID extraction
g6 <- egoFb7$geneID
Str <- unlist(strsplit(g6, "/"))
df <- as.data.frame(Str)
colnames(df) <- c("gene")

## signature Genes in count matrix
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)
if (nrow(signGenes) == 0) stop("No signature genes found.")

## sce object for signature genes
sceSub <- sce[rownames(sce) %in% unique(signGenes$geneID), ]
if (nrow(sceSub) == 0) stop("No matching genes found in sce.")

## gene signature matrix
cntMat <- rowSums(t(as.matrix(sceSub@assays@data$logcounts))) / nrow(signGenes)
if (length(cntMat) != ncol(sceSub)) stop("Mismatch between cntMat and sceSub dimensions.")

sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign

sceSub$sign2[which(sceSub$sign > 2)] <- 2


sc <- scale_colour_gradientn(colours = pal(100), limits = c(0, 2))

## UMAP all conditions 
plotUMAP(sceSub, colour_by = "sign2", point_size = 0.5) + sc

## Sarcoidosis: 
sceSarcoSub <- sceSarco[which(rownames(sceSarco) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSarcoSub@assays@data$logcounts)))/nrow(signGenes)
sceSarcoSub$sign <- cntMat
sceSarcoSub$sign2 <- sceSarcoSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceSarcoSub$sign2[which(sceSarcoSub$sign > 1)] <- 1
#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceSarcoSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()


## Donor Heart: 
sceDHSub <- sceDH[which(rownames(sceDH) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceDHSub@assays@data$logcounts)))/nrow(signGenes)
sceDHSub$sign <- cntMat
sceDHSub$sign2 <- sceDHSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceDHSub$sign2[which(sceDHSub$sign > 1)] <- 1

#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceDHSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()



```



## Innate immune response
```{r}

egoTRM1 <- dplyr::filter(egoTRM@result, egoTRM@result$Description %in% c("innate immune response activating cell surface receptor signaling pathway", "activation of innate immune response", "innate immune response-activating signaling pathway", "innate immune response in mucosa"))


## geneID extraction
g8 <- egoTRM1$geneID
Str <- unlist(strsplit(g8, "/"))
df <- as.data.frame(Str)
colnames(df) <- c("gene")

## signature Genes in count matrix
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)
if (nrow(signGenes) == 0) stop("No signature genes found.")

## sce object for signature genes
sceSub <- sce[rownames(sce) %in% unique(signGenes$geneID), ]
if (nrow(sceSub) == 0) stop("No matching genes found in sce.")

## gene signature matrix
cntMat <- rowSums(t(as.matrix(sceSub@assays@data$logcounts))) / nrow(signGenes)
if (length(cntMat) != ncol(sceSub)) stop("Mismatch between cntMat and sceSub dimensions.")

sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign

sceSub$sign2[which(sceSub$sign > 2)] <- 2


sc <- scale_colour_gradientn(colours = pal(100), limits = c(0, 2))

## UMAP all conditions
plotUMAP(sceSub, colour_by = "sign2", point_size = 0.5) + sc



## Sarcoidosis 
sceSarcoSub <- sceSarco[which(rownames(sceSarco) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSarcoSub@assays@data$logcounts)))/nrow(signGenes)
sceSarcoSub$sign <- cntMat
sceSarcoSub$sign2 <- sceSarcoSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceSarcoSub$sign2[which(sceSarcoSub$sign > 1)] <- 1
#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceSarcoSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()

## Donor Heart: 
sceDHSub <- sceDH[which(rownames(sceDH) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceDHSub@assays@data$logcounts)))/nrow(signGenes)
sceDHSub$sign <- cntMat
sceDHSub$sign2 <- sceDHSub$sign
##check max and min values
##max(sceSub$sign)
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1))
sceDHSub$sign2[which(sceDHSub$sign > 1)] <- 1

#pdf("umap_.pdf", width = 8, height = 6) 
plotUMAP(sceDHSub, colour_by = "sign2", point_size = 0.5) + sc +
  theme(legend.position = "none")
#dev.off()

```


```{r}

date()
sessionInfo()

```

